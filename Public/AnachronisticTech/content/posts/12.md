---
date: 18/02/2019
summary: After completely failing to create a dual-boot Windows 7/10 system over the Christmas holidays, I decided it was time for Round Two.
type: project
---

# UPDATED – What have I been upgrading this week? – Desktop Hardware and OS

> "Best laid plans of mice..." - Slartibartfast, Hitchhikers Guide to the Galaxy

Before anyone says anything nasty: I'm perfectly capable of installing a new operating system. I've done it lots of times successfully in the past; the problems happened when I tried to do something a little more complex...

Over the Christmas holidays I went home to Cyprus. I booted up my Windows 7 desktop to get started on some work (that's a lie, it was likely for gaming), but noticed it wasn't quite as quick as I remembered. For the longest time I avoided upgrading to Windows 10, but I've grown to like some of its features on my laptop. I considered finally jumping from 7 to 10 on the desktop, but I wasn't keen on sacrificing one OS in case the new one didn't work.

No problem; partition the drive. The only issue was I'd have to install Windows then all my programs and settings from scratch. Sure I could do it, but who wants to spend that kind of time... Inspiration struck when I looked to my laptop for assistance. I could just clone it and deploy it from an image! Using Macrium Reflect, I got everything prepared and started the procedure. Things were going well until I overwrote the boot loader and lost access to both operating systems. I managed to get it back into working condition within 36 hours, but still no Windows 10. After pulling teeth just to restore access to Windows 7, I counted myself lucky the damage wasn't extreme and dropped the whole project.

## Round Two

Fast-forward two months: I had to send my laptop back to the vendor to repair a broken key on the keyboard. I backed up everything of value and got ready to send it off with the knowledge that I could use my Windows 7 desktop *and* a virtual machine image of my laptop in the interim.

However, the VM was quite slow, and was running on a Windows 7 host. The gears began to turn once more: what if I could deploy the image to a physical machine? Flashbacks to my earlier failure made me think I went about it the wrong way last time. This time, I would deploy to a brand new drive while the original one was disconnected. Hopefully there would be no risk of damaging the boot loader again, and if anything went wrong with the deployment process I could just wipe the drive and start with a fresh build of Windows 10, leaving Windows 7 happily intact.

I found a great deal on Amazon for a 500GB M.2 solid state disk; it was really quite a bargain. It arrived a few days later at a nearby locker, and after imaging the virtual clone of my laptop, I installed the tiny stick of storage and booted from the special recovery USB. Within fifteen minutes I had moved the contents of the image to the new disk and updated the boot loader. All that was left was to reboot and hope things hadn't gone terribly wrong.

At this stage, I'd just like to remind readers that the last time I did this, it cost me 36 hours just to get back into my Windows install. It involved some weird ideas like using a gParted CD, an Ubuntu live USB, three *different* versions of the Windows 7 recovery tools, virtual machines, a fresh install of Windows in a new partition, and a PS/2 keyboard that was lying around in some cupboard. It was a zany day and a half, but I got everything working again. That in no way meant I wanted to repeat that experience... This time, my precautions amounted to "unplug the Windows 7 disk before starting". It seemed like a good way to protect the boot loader.

Imagine my surprise when Windows 10 booted without issue... mostly! A couple of drivers hadn't been installed and one of my monitors hadn't been detected, but, relatively speaking, things were looking good! A quick update of the nVidia graphics driver got the second screen up and running, and Windows Device Manager made short work of the other PCI devices that hadn't had drivers downloaded for them. OneDrive gave me a few issues with an already existing folder that wasn't expected to be there. Who'd have guessed I keep OneDrive in the same location on multiple computers? Madness! Fortunately, OneDrive isn't as dumb as it used to be way back when. I had to go through the setup again, but pointing it to the same place worked out fine, and it went about its business merging all the changes that weren't actually different. Could have been worse.

After about an hour of use, I declared the system stable, and decided to see what the state of my Windows 7 build was. I powered everything down, plugged the disk back into the motherboard and power, and rebooted. Because I was slow, I missed the prompt to select a boot device, so it defaulted to Windows 10 which, helpfully, booted without issue. I took the opportunity to check if the Windows 7 disk had at least been recognised by the system, but it was notably absent from the list of available disks. I switched it all off again, checked the connections were fine, and rebooted, taking care to not miss the prompt this time.

The boot device prompt looked a little strange. The new Windows 10 disk had two options, "Windows Boot Loader" and "UEFI". The former directed the system to plain old Windows 10, while the latter launched the recovery menu. At least now I knew where that could be found if I ever needed it. Next, three SATA devices were listed, "SATA3", "SATA5", and "SATA6". The significance of the numbers was the port on the motherboard where each disk was plugged in. Each of the three options also had an identifier next to it. Strangely, "SATA5" had the same identifier as the Windows 10 options, which was definitely not supposed to happen.

Looking through the manual for the motherboard, it appeared to have an odd restriction on which SATA ports could be used while M.2 slots were also active. It turned out that by adding a SATA M.2 disk to the second available slot on the motherboard, the "SATA5" port had been locked out. It seems the motherboard uses the same connections internally for SATA cables and M.2 disks, which explained why "SATA5" had the same identifier as the M.2 disk. I swapped the cable in "SATA5" to another port, but inadvertently mixed up cables 4 and 6 in the process without realising. Rebooting the PC without selecting a boot device, Windows 10 still loaded without issue, and confirmed that a new disk had been detected. Rebooting and accessing the boot device list, a new "Windows Boot Loader" option appeared with a new identifier that I recognised belonged to the disk where Windows 7 was installed. I selected it and was greeted with the familiar Windows logo animation and text "Starting Windows". All was good...

![The table in the motherboard manual explaining which hard disk ports are available when used with M.2 drives. Makes a fair amount of sense...](334FAB52-6AFE-45ED-8BD5-B39F3DB4966E.jpeg)

Remember I said I mixed up the two disk cables? Windows 7 didn't like that very much. It insisted, several times, on running CHKDSK, the Windows disk integrity checking tool, to ensure all the disks were still functioning properly. I didn't have a problem with this; it could only be good to check all the drives were fine. About forty minutes into the second run of CHKDSK I was starting to fall asleep. Data integrity is great, but three terabytes of storage takes a while to scan. Still, it eventually finished, and - because I was half asleep and missed the prompt - Windows 10 loaded. I rebooted once more, hit the right option in the boot device menu, and after another prompt to CHKDSK - which I graciously declined - my familiar Windows 7 environment was ready to go!

## Teething Problems

Once both OSs were behaving themselves, a couple of problems cropped up. One was OneDrive again. Now that it was set up on Windows 10, Windows 7 could no longer access the directory. Initially I thought maybe it couldn't read the entire disk for some reason, but that theory was quickly thrown out. The next idea was that it might have been a permissions issue or something to do with effective owner. No luck there either, so I decided to check online. I was disappointed there weren't more posts relating to dual-booting Windows 7 and 10, but then what kind of person would want a setup like that... I did, however, find posts regarding sharing OneDrive folders between Windows 10 and Linux distributions, and those solved the issue easily.

OneDrive implementation varies significantly from operating system to operating system. On Windows 7, Linux distributions, and macOS, OneDrive behaves as a synchronisation client. It mirrors all changes between the cloud and the device, with the implication that everything accessible to the device is stored somewhere local to that device. Windows 8 and 8.1 uses a technology known as "shadow files" that allows the OS to use files that aren't stored on the device at the time but are still visible to the filesystem. The Windows 10 implementation is almost a mix of the two. Files in the cloud are visible to the OS but must be downloaded before use. Those files then remain local until they are removed due to lack of use - though they persist in the cloud - or remain on the device permanently if the user insists. This is a useful feature since a user can choose files or folders to stay local so only changes are synced, saving on bandwidth and data charges as it means files don't have to be redownloaded every time they are accessed.

The solution, then, to this problem was to set the Windows 10 OneDrive client to behave like the Windows 7 one and keep all files downloaded. It really was as simple as flicking a switch; the OneDrive settings menu contains a checkbox controlling this very feature. The Windows 10 client checked all files were in order, and on completion I booted into Windows 7. The OneDrive folder was now accessible, but the client still needed to be set up again, so I had to sit through another hour of it merging changes that didn't exist. I left it overnight, and the next day, both OSs reported OneDrive was synced and ready to go!

The final issue was iTunes. I use iTunes for managing my music collection and syncing my phone, and I keep all its data on a separate drive, like OneDrive (I did at one point consider storing it *in* OneDrive, but it didn't work out very well). However, iTunes behaves a little weirdly sometimes when it comes to reading the library file. The file is written in XML, and it is (unfortunately) easy to damage. I took a backup and stored it in a separate file so I could rollback if things went sideways. I launched iTunes on Windows 7, no problems. Great, now Windows 10: also good. Excellent, things were looking up. Relaunch on Windows 7, "Error. This library cannot be opened since it has been opened with a newer version of iTunes."

To protect the library, iTunes wouldn't open a file from a newer version. This was likely so the addition of new features wouldn't cause an older version of iTunes to become unstable, but it had kind of thrown my plans out the window. The solution to this, though, was much simpler than the OneDrive problem; I just had to update both copies of iTunes to the same version. After sitting through the two installations, I checked the library worked by alternating launching iTunes on Windows 7 and 10 and making sure there were no errors. Things had sorted themselves pretty well, though it did mean if I wanted to update iTunes for whatever reason later down the line, I would have to update the other one too.

## Wrap-Up

Deploying a virtual machine clone to a physical computer was much easier the second time. There were nowhere near the number of headaches and panics during this attempt as opposed to the first time over Christmas. It's also convenient that the two OSs can share a OneDrive folder so I don't have to duplicate data needlessly. Sharing an iTunes library is similarly convenient, though the updating issue may become a problem in the future. If I were building a dual-boot system like this from scratch (one that isn't my primary device) I might have looked into a way of installing programs in a single location where possible so programs could be shared as well as data. 

In any case, the procedure has thus far worked better than expected. Due to the way I mirror directory structure across devices so I don't have to remember as much, Steam detected my entire library of games instantly, skipping the need to validate files and reinstall lots of data. Even better, updates to games from one OS apply instantly to the other since the files are on a common drive. 

In the future, depending on how well Windows 10 works out for me, I may decide to finally get rid of Windows 7, and repurpose the SSD for something else. For the moment, however, I'm still considering this an extended test. I'm betting I've missed a few programs which will cause me problems, and I'm also certain I'll find a way to muck things up before too long. I guess I'd better not delete the original virtual machine!

## Update

The whole system collapsed in less than a week due to Windows Fast Boot. Windows 10 utilises Fast Boot to improve boot times after shutdown. It's like Hibernate, but doesn't save _everything_ in RAM to disk; instead, running processes are stopped like in shutdown, but the state of the kernel is saved to disk. A side effect of this, however, is that disks are set to a state where they shouldn't be written to while the operating system is inactive. Using the disks, for example, bu swapping between two versions of Windows causes Windows to flag the disks as potentially damaged by setting the "dirty bit".

This bit causes Windows to request a CHKDSK for each damaged drive. _Every_ drive, in this case, and every time I swapped between Windows 7 and 10. It got to the stage where every reboot required a twenty-minute disk check. I tried to fix the problem, and somehow managed to set one of the disk filesystems to RAW (the contents of the drive were intact, but some of the metadata had been damaged). Eventually, the system became unusable, but I had finally narrowed down the issue to Fast Boot. I was forced to re-deploy Windows 10 from scratch, but now I knew the process, it took considerably less time to set up and fix the OneDrive and iTunes issues.

I disabled Fast Boot in the BIOS and in the Windows 10 power options, but the issue persisted. The answer I found came from an old post on the Microsoft forums about also disabling Hibernate, since both Hibernate and Fast Boot are based on similar systems. I use Hibernate on my laptop, but never on desktop, so I bit the bullet and disabled it in the power options. It has since been three weeks of interchanging between Windows 7 and 10, and constant CHKDSKs have not returned. I know it exists for an excellent reason (to safeguard disk integrity), but good riddance!